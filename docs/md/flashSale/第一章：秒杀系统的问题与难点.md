# 第一章：秒杀系统的问题与难点
> 你好，我是溯，一名普通的开发。

一个着迷于技术又喜欢不断折腾的技术活跃者，从16年毕业进入互联网，开发过交易、营销类项目，实现过运营、活动类项目，设计过中间件，组织过系统重构，对架构的设计和落地有丰富的经验。

TODO 画一个Xmind

## 背景介绍
从用户角度来理解秒杀其实是一件非常容易的事情，不用我赘述，你可能早已了然于心，甚至对如何得手可能还颇有心得。可是，我们不仅是普通的用户，而且是技术人员，甚至是秒杀架构的缔造者。我们的理解的角度怎么可以和普通用户一样？

所以，如何从技术的角度，洞见秒杀系统的内涵，理解秒杀系统的精要，设计出可靠的秒杀系统才是我们关心的重点所在，为防止后续可能会对此问题有所遗忘导致设计有所丢失，故做一些总结。

秒杀在设计上分为2种，**主动秒杀**和**被动秒杀**

- 被动秒杀：火车票这种常驻商品属于被动秒杀，即无法区分秒杀品和常规品
- 主动秒杀：电商活动属于主动秒杀，即由运营人员设置活动时间与商品，到期开始执行秒杀价的。

但是，无论是主动秒杀还是被动秒杀，只要出现了不可避免的秒杀场景，就必须要从业务和技术两个层面抓住秒杀的目标，因为目标是设计与架构的靶向。

## 秒杀的目标
通常，我们把秒杀看作是高并发的典型场景，是大量请求对有限资源的瞬时争夺，是用户对系统发起的压力测试。然而，这话其实并不完全准确，秒杀与高并发的关系可疏可密 。

因为，秒杀系统的核心目标是实现大流量对有限资源的瞬时争夺。围绕这个核心目标，我们可以进一步将其拆解为三个关键目标，分别是C端目标、B端目标和平台目标。

### （一）C端目标
C端用户是上帝。在秒杀体验过程中上帝的体验是否流畅、数据是否无误至关重要，所以我们要首先保障用户的体验。为什么这么说呢？

对于大部分上帝而言，体验是最直观的感受，突然的卡顿、白屏、宕机等糟糕的体验会导致上帝逐渐失去对我们的眷顾，甚至对我们的技术能力产生怀疑。而能否秒杀成功倒是其次，大部分上帝在秒杀时都默认自己抢不到，他们不会因为抢不到而大为恼火。

### （二）B端目标
如果说C端用户是上帝，那么B端用户就是我们的金主（如果B端就是自己的公司，那我们要更为谨慎，因为公司不仅是金主，更是雇主，甚至是你的饭碗）。对于金主而言，在价格、数量和资金上都不能出错。

首先是价格，秒杀品的价格一般有别于其他渠道的商品，哪怕是同样的商品，价格也会存在差异，所以在价格上我们要做到渠道隔离。其次是数量，也就是不能超卖，超卖的后果很严重，会直接造成资损或服务无法兑现，客诉会接踵而至，甚至引发舆情，甚至可能杀个程序员祭天。

最后是资金安全，除了超卖会导致资损外，还有一种情况也会造成资损，那就是恶意下单。如果你的竞争对手或者某些恶意用户在瞬间下单了你的所有商品，但就是不付款，这种情况会导致B端因在秒杀活动中无法进账而引发资损，不仅活动前期的推广费用、活动费用无法回收，可能还会导致更为严重的连锁反应。

### （三）平台目标
至于平台的首要目标则是保障C端期望和B端期望的顺利实现。 其次，平台的业务往往不止秒杀一种，所以在秒杀活动期间，要保证不能影响到平台其他业务的正常开展。比如，如果我们把秒杀的流量洪峰直接引到其他非重保的应用上，轻则受牵连的应用宕机，重则因雪崩效应而导致整个平台宕机。

在设计秒架构时，以上三个目标都必须全部实现。如果其中某个目标未能实现，可能会导致系统，提桶走人也并非耸人听闻。

从秒杀系统的目标来看，我们可以总结出秒杀过程中的几个明显的特征：

- 瞬时大流量：从秒杀开始的前期，流量会逐渐聚集，在秒杀开始的瞬间，流量会瞬间涌入，监控图上也会体现出瞬间跳起，竖起一根芒刺

- 高并发：虽然大流量并不一定意味着高并发，但在秒杀场景中，大流量将直接导致高并发。高并发系统的设计与普通系统的设计有着很多不同，即使提供同样的服务，两者在设计上也会有着天壤之别

- 高可用：在任何情况下，我们不能让系统宕机，不能让C端用户失望。
- 高性能：即使在洪峰流量下，也要保证C端用户的流畅体验，不能出现白屏、明显卡顿等情况
- 读多写少：大流量是"读"，只有在并发中竞争成功的才会涉及到"写"。然而，成功者毕竟是极少数，所以“读多写少”也是秒杀系统的关键特征
- 数据强一致性：数据一致性体验在两个方面，一是所有C端用户所看到的秒杀开始时间、库存等信息一致，二是最终成单数量与库存一致，不可以存在超卖的情况。
- 资源隔离：秒杀系统的问题，不能让兄弟应用承担流量。

## 秒杀系统的挑战
正如我们所见，秒杀系统具有多维度的目标要求，以及高流量、高并发和高性能等“三高”特征，而正是这些决定了技术的难点和挑战。与普通系统不同，高并发所导致的系统质变，将影响整个链路上的各个环节，其中任何一个环节的疏忽和故障都将会造成全局的失败。所谓质变，指的是原本体验良好、功能正常的系统，在瞬时高压下会变得极度脆弱，乃至于瞬时崩溃。

TODO 画一个秒杀请求流程图

### （一）C端前端
#### 保证资源的加载速度
静态资源一定要放在CDN，防止流量将整个系统的带宽打崩
#### 打散流量
其次，流量洪峰的特点是流量比较集中，集中的流量会导致拥堵和高并发。因此，我们需要考虑在客户端将流量打散，避免所有用户在同一时刻发出请求。比如，常见的做法有滑块、验证码和问答等，每个人的操作速度和问答速度不可能完全一致，所以我们可以利用这点来打散流量。甚至可以加以随机数来请求[可能会导致先点的后到等，不过一般C端用户无感知]

### （二）C端服务端
#### 保证系统的高可用
整个链路压力测试[有时长达一两天高压测试]，甚至宕机其中一两个节点进行模仿生产事故或者紧急蓝绿发布
#### 削峰限流
当客户端的流量洪峰过来后，需要对流量进行逐层地拦截和过滤。防止系统因为承接了高于预计承接范围内的流量导致系统宕机，确保最后到达的流量是安全的，可持续的
#### 系统的响应速度
随着流量的激增，系统的负载可能会线性增加。但是，我们不能因此而降低系统的响应速度。一般而言，接口的响应速度应当保持在50ms以内。
#### 秒杀品不被超卖
正如前文所述，超卖的后果很严重，在这方面我们需要慎重设计下单减库存的策略。一旦用户冲破了层层关卡，进入最终的下单环节，性能将不再是主要的考量，数据一致性才是。所以，在减库存操作方面，需要多方面的校验，确保万无一失。
#### 资源隔离和风险
应当对于所有对接的其他模块接口询问最大请求速率，因为非秒杀场景的接口可能并不支持这么大的并发，如果在错误的设计和未考虑流量隔离的问题下可能会导致其他其他模块直接系统不可用，进而导致不可用服务的蔓延，此处要么调用其他模块的东西限流，要么其他模块本身有做限流。
#### 设计有效的缓存策略
秒杀系统的一个关键特征是“读多写少”，因此缓存的使用必不可少。可问题是，虽然缓存可以提高响应速度，但存在数据一致性问题，我们需要保证过程中中心化缓存、本地缓存和数据库之间的数据一致。
#### 黄牛和秒杀器
由于秒杀品一般存在着较大的利益空间，很多用户为了增加成功的概率，会使用多设备、自动化脚本等手段参与秒杀，这就催生了职业化的代秒选手的出现。这些选手有着成熟的、丰富的秒杀设备，他们的存在会严重扰乱秒杀活动的正常进行，设计不完善的秒杀系统可能会被黄牛瞬间抢购一空，其后果可想而知。所以，如何对黄牛和恶意攻击也是秒杀系统中的关键考量。
#### 突增的网络带宽
网络带宽的暴增会导致当前节点的带宽不够，进而导致本机器的所有服务不可用，此处可能是一个问题[此处和运维商量后，运维做了处理]
#### 足够的监控
如果我们不能度量系统，我们将无法设计系统和实时监听系统问题。因此，虽然监控是最后的挑战，但这并不影响它至关重要的地位。对于秒杀系统链路上的所有环节，都应该具有实时的、量化的指标可查看。同时，可以预先评估的流量和环节设计的阈值，设置相应的报警水位。
